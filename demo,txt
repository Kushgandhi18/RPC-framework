CC = gcc
CFLAGS = -Wall -Wextra -pthread -I./include
LDFLAGS = -ldl -pthread

# Directories
SRC_DIR = .
OBJ_DIR = obj
BIN_DIR = bin
INC_DIR = include

# Detect OS
ifeq ($(OS),Windows_NT)
    # Windows commands
    RM = rmdir /S /Q
    MKDIR = if not exist $(subst /,\,$(1)) mkdir $(subst /,\,$(1))
    FixPath = $(subst /,\,$1)
    EXE_EXT = .exe
else
    # Unix commands
    RM = rm -rf
    MKDIR = mkdir -p
    FixPath = $1
    EXE_EXT =
endif

# Source files
SERVER_SRC = server/server.c server/rpc_server.c server/dl_handler.c
CLIENT_SRC = client/client.c client/rpc_client.c
COMMON_SRC = common/message_handler.c

# Object files
SERVER_OBJ = $(patsubst %.c,$(OBJ_DIR)/%.o,$(SERVER_SRC))
CLIENT_OBJ = $(patsubst %.c,$(OBJ_DIR)/%.o,$(CLIENT_SRC))
COMMON_OBJ = $(patsubst %.c,$(OBJ_DIR)/%.o,$(COMMON_SRC))

# Executables
SERVER_BIN = $(BIN_DIR)/rpc_server$(EXE_EXT)
CLIENT_BIN = $(BIN_DIR)/rpc_client$(EXE_EXT)
TEST_BIN = $(BIN_DIR)/message_test$(EXE_EXT)

# Example shared library
ifeq ($(OS),Windows_NT)
    EXAMPLE_LIB = $(BIN_DIR)/example.dll
else
    EXAMPLE_LIB = $(BIN_DIR)/libexample.so
endif

# Default target
all: directories $(SERVER_BIN) $(CLIENT_BIN) $(EXAMPLE_LIB)

# Create necessary directories
directories:
ifeq ($(OS),Windows_NT)
	@if not exist obj\server mkdir obj\server
	@if not exist obj\client mkdir obj\client
	@if not exist obj\common mkdir obj\common
	@if not exist bin mkdir bin
else
	@mkdir -p $(OBJ_DIR)/server
	@mkdir -p $(OBJ_DIR)/client
	@mkdir -p $(OBJ_DIR)/common
	@mkdir -p $(BIN_DIR)
endif

# Build server
$(SERVER_BIN): $(SERVER_OBJ) $(COMMON_OBJ) examples/demo_server.c
	$(CC) $(CFLAGS) examples/demo_server.c $(SERVER_OBJ) $(COMMON_OBJ) -o $@ $(LDFLAGS)

# Build client
$(CLIENT_BIN): $(CLIENT_OBJ) $(COMMON_OBJ) examples/demo_client.c
	$(CC) $(CFLAGS) examples/demo_client.c $(CLIENT_OBJ) $(COMMON_OBJ) -o $@ $(LDFLAGS)

# Build message test
test: directories $(COMMON_OBJ) common/message_test.c
	$(CC) $(CFLAGS) common/message_test.c $(COMMON_OBJ) -o $(TEST_BIN) $(LDFLAGS)
	$(TEST_BIN)

# Build example shared library
$(EXAMPLE_LIB): examples/example_functions.c
ifeq ($(OS),Windows_NT)
	$(CC) -shared examples/example_functions.c -o $@
else
	$(CC) -fPIC -shared examples/example_functions.c -o $@
endif

# Generic rule for object files
$(OBJ_DIR)/%.o: %.c
ifeq ($(OS),Windows_NT)
	@if not exist $(subst /,\,$(dir $@)) mkdir $(subst /,\,$(dir $@))
else
	@mkdir -p $(dir $@)
endif
	$(CC) $(CFLAGS) -c $< -o $@

# Clean build artifacts
clean:
ifeq ($(OS),Windows_NT)
	@if exist obj rmdir /S /Q obj
	@if exist bin rmdir /S /Q bin
	@echo Cleaned build artifacts
else
	rm -rf $(OBJ_DIR) $(BIN_DIR)
endif

# Clean and rebuild
rebuild: clean all

# Run server
run-server: $(SERVER_BIN) $(EXAMPLE_LIB)
	$(SERVER_BIN)

# Run client
run-client: $(CLIENT_BIN)
	$(CLIENT_BIN)